<!DOCTYPE html><html lang="en-US"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/><title>Scheme implement models &mdash; cat.io</title><link href="/index.xml" rel="alternate" type="application/atom+xml"/><link href="/css/valkyrie.css" rel="stylesheet" type="text/css"/><link href="/css/screen.css?1704081713" rel="stylesheet" type="text/css"/></head><body><div class="header"><div class="container"><nav><div class="logo"><a href="/">cat.io</a></div><ul class="menu"><li class="menu__item"><a href="/">Posts</a></li><li class="menu__item"><a href="/page/projects">Projects</a></li><li class="menu__item"><a href="/page/talks">Talks</a></li><li class="menu__item"><a href="/page/about">About</a></li></ul></nav></div></div><div class="document"><div class="container"><h1 class="document-title document-title-dated" data-date="2023-12-09">Scheme implement models</h1><article><p>此前一直对 Chez Scheme 的实现非常感兴趣，好奇为何其在众多的 scheme 实现中
性能一直领先。我从源代码编译 Chez 本身，编译速度惊人（1min 左右）。尤其对比 Gambit Scheme 实现，
其编译到 C 语言之后，也确实有着很不错的执行效率，但是编译速度堪忧，编译整个 Gambit 系统至少需要一个小时（在笔者的 Mac Pro 2019 上）。</p><p>读了 R. Kent Dybvig 的 paper <a href="https://citeseerx.ist.psu.edu/document?repid=rep1&amp;type=pdf&amp;doi=bc896e5336120b0f4ad00feb500cd7ce70134836">Three Implementation Models for Scheme</a>，
了解到 scheme 主流的三种实现模型，heap-based model, stack-based model, string-based model。</p><p>其中，heap-based model 被很多 scheme 实现所使用，优点是实现容易，其最大的缺点是内存占用会比较高，且由于 Environment
也是分配在 heap 上，导致变量的寻址也会占用不少的时间。此前大家基于 heap 来实现 Scheme 而不是使用大部分
计算机架构都支持的 "true stack" 来实现，是因为，Scheme 天然支持 first-class closure，first-class
continuation 等特性，而 Closure 的创建需要将环境也一同保存下来，很自然的如果 Enrionment 分配在 heap
上面，直接保存就可以，而基于 "true stack" 的话，需要考虑 copy stack frame，要知道 stack 里面的内容不止
有变量值还有控制信息。Dybvig 通过巧妙的改造，使得 "true stack" 也适用于 Scheme 的实现，这样极大的提高了内存的分配量以及执行速度，
因为可以使用操作 stack 的指令集。另外，该模型也会使用 heap，不过只有少部分情况，主要是涉及对于 first-class continuation
的支持 (需要拷贝栈内容到 closure) 。后续文章将会详细介绍 stack-based model，与大家分享，也希望错误的
理解能被纠正。</p><p>另外， <a href="https://citeseerx.ist.psu.edu/document?repid=rep1&amp;type=pdf&amp;doi=bc896e5336120b0f4ad00feb500cd7ce70134836">Three Implementation Models for Scheme</a> 的可读性非常高，Dybvig 的文笔读起来非常舒服。paper 里面的 <a href="https://github.com/evalwhen/dybvig-three-imp">代码</a> 都是可以执行的，
有很多抽象机的实现，非常优雅和简洁。而这很大程度上是得益于 Scheme 代码即数据的优点。Enjoy!</p></article></div></div><div class="footer"></div></body></html>